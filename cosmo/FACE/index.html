<!DOCTYPE html>
<html lang="en" >

<head>
  <title>COSMO</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
    <button id="helloCosmo">Hello COSMO</button>
    <div id="output" style="color: white;"></div>
    <script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
    <script>
        const sounds = {
            smile: new Audio('sounds/smile.mp3'),
            blink: new Audio('sounds/blink.mp3'),
            sad: new Audio('sounds/sad.mp3'),
            angry: new Audio('sounds/angry.mp3'),
            focused: new Audio('sounds/focused.mp3'),
            confused: new Audio('sounds/confused.mp3'),
            think: new Audio('sounds/think.mp3'),
            cat: new Audio('sounds/cat.mp3'),
            forest: new Audio('sounds/forest.mp3'),
            blinking: new Audio('sounds/blinking.mp3')
        };

        for (let key in sounds) {
            sounds[key].preload = 'auto';
        }

        // Single click handler
        helloCosmo.addEventListener('click', async () => {

            // 1️⃣ Unlock all sounds (iOS requirement)
            for (let key in sounds) {
                try { await sounds[key].play(); } catch(e) {}
                sounds[key].pause();
                sounds[key].currentTime = 0;
            }

            // 2️⃣ Start COSMO
            getStarted();

            // 3️⃣ Hide button
            helloCosmo.style.opacity = 0;
            setTimeout(() => helloCosmo.style.display = 'none', 300);

            // 4️⃣ Play blink immediately (direct gesture)
            if (typeof eyes !== 'undefined') {
                eyes.blink();
                sounds.blink.currentTime = 0;
                sounds.blink.play();
            }            
        });

        const output = document.getElementById('output');

        function log(message) {
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        async function getStarted() {
            const realtimeClient = new Ably.Realtime({
                key: 'CClXdw.Z3P7Fw:G1W_WXLZYUpqqnjvplbv_GDmUJ3TB4lk1bs54DblqpE',
                clientId: 'cosmo_face'
            });

            await realtimeClient.connection.once('connected');
            //log('Made my first connection!');

            const channel = realtimeClient.channels.get('cosmo_face');

            await channel.subscribe((message) => {
                //log(`Received message: ${message.data}`);

                // If the message is "smile", make COSMO happy
                if (message.data === 'smile') {
                    eyes.express({ type: 'happy' });
                    sounds.smile.currentTime = 0;
                    sounds.smile.play();
                }
                // Blinking
                if (message.data === 'blink') {
                    eyes.blink()
                    sounds.blink.currentTime = 0;
                    sounds.blink.play();
                }
                // Other emotions
                if (message.data === 'sad') {
                    eyes.express({ type: 'sad' });
                    sounds.sad.currentTime = 0;
                    sounds.sad.play();
                }
                if (message.data === 'angry') {
                    eyes.express({ type: 'angry' });
                    sounds.angry.currentTime = 0;
                    sounds.angry.play();
                }
                if (message.data === 'focused') {
                    eyes.express({ type: 'focused' });
                    sounds.focused.currentTime = 0;
                    sounds.focused.play();
                }
                if (message.data === 'confused') {
                    eyes.express({ type: 'confused' });
                    sounds.focused.currentTime = 0;
                    sounds.focused.play();
                }
                if (message.data === 'think') {
                    eyes.express({ type: 'happy' });
                    sounds.think.currentTime = 0;
                    sounds.think.play();
                }
                if (message.data === 'cat') {
                    eyes.express({ type: 'happy' });
                    sounds.cat.currentTime = 0;
                    sounds.cat.play();
                }
                if (message.data === 'forest') {
                    eyes.express({ type: 'startBlinking' });
                    sounds.forest.currentTime = 0;
                    sounds.forest.play();
                }                
                if (message.data === 'startBlinking') {
                    eyes.startBlinking()
                    sounds.blinking.currentTime = 0;
                    sounds.blinking.play();
                }
                if (message.data === 'stopBlinking') {
                    eyes.stopBlinking()
                }                                                 
            });
        }

        getStarted();
    </script>  

    <!-- Uncomment for designiing new emotions
    <div class="buttons">
        <button onclick="eyes.express({type: 'happy'})">Smile</button>
        <button onclick="eyes.blink()" >Blink</button>        
        <button onclick="eyes.express({type: 'sad'})">Sad</button>
        <button onclick="eyes.express({type: 'angry'})">Mad</button>
        <button onclick="eyes.express({type: 'focused'})">Focused</button>
        <button onclick="eyes.express({type: 'confused'})">Confused</button>
        <button onclick="eyes.startBlinking()">Start Blinking</button>
        <button onclick="eyes.stopBlinking()">Stop Blinking</button>        
    </div>
    -->

    <div class="face">
        <div class="eye left">
            <div class="eyelid upper"></div>
            <div class="eyelid lower"></div>
        </div>
        <div class="eye right">
            <div class="eyelid upper"></div>
            <div class="eyelid lower"></div>
        </div>
        <div class="mouth"></div>
    </div>

    <script src="js/face.js"></script>
    <script src="js/speak.js"></script>
</body>